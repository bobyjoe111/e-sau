<html>
	<head>
		<title>E-Say</title>
		<link rel = "icon" href = "/logo.png" type = "image/x-icon">
		<link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300&display=swap" rel="stylesheet">
		<style>
			* {
				font-family: "Comfortaa", cursive; 	
			}

			body {
				background-color: skyblue;
			}
			
			.block {
				min-width: 10%;
  			max-width: 40%;
				padding: 10px;
				background-color: blue;
				border-radius: 25px;
				overflow-x: hidden;
				display: inline-block;
			}

			input, button {
				margin-top: 2px;
				text-align:center;
			}
			
			input {
				width: 98%;
				border-radius: 10px;
				padding: 5px;
			}

			#bottom {
				text-align: center;
				width: 100%;
				position: fixed;
				bottom: 0.5px;
				left: 0px;
				background-color: green;
			}
			
		</style>
	</head>
	<body>
		<div id='logs'></div>
		<br><br><br><br><br><br><br><br><br><br><br>
		<div id='bottom'>
			<br>
			<button id='back'>Back</button><br>
			<input id='groupName' placeholder='group username'><br>
			<input id='groupPassword' placeholder='group password'><br>
			<button id='getGroup'>Visit Page</button><br>
			<input id='dataMessage' placeholder="message"><br>
			<button id='submit'>Submit</button><br><br>
		</div>
		
		<script>
			function newH(text, text1, div, left) {
				const container = document.createElement("div");
				
				const newDiv = document.createElement("div");
				newDiv.className = 'block';
				var para = document.createElement("h3");
				var node = document.createTextNode(text);
				para.innerHTML += '';
				para.appendChild(node);
				newDiv.appendChild(para);

				var p = document.createElement("p");
				var n = document.createTextNode(text1);
				p.appendChild(n);	
				newDiv.appendChild(p);

				container.appendChild(newDiv);
				document.getElementById(div).appendChild(container);
				container.style.marginBottom = '2px';
				container.width = "100%";
				if (left) {
					container.style.textAlign = 'left';
					p.style.textAlign = "left";
					para.style.textAlign = "left";
					newDiv.style.marginLeft = '0px' ;
					newDiv.style.marginRight = 'auto';
					newDiv.style.backgroundColor = 'gray';
				} else {
					container.style.textAlign = 'right';
					p.style.textAlign = "right";
					para.style.textAlign = "right";
					newDiv.style.marginLeft = 'auto' ;
					newDiv.style.marginRight = '0px';
				}
				
			}

			var past = document.getElementById('dataMessage');
			var submit = document.getElementById('submit');
			var back = document.getElementById('back');
			var groupName = document.getElementById('groupName');
			var groupPassword = document.getElementById('groupPassword');
			var getGroup = document.getElementById('getGroup');
			var go = false;
			var q = window.location.search;
			q = q.slice(q.indexOf('=')+1, q.length);
			q = atob(q);
			
			back.addEventListener("click", function() {
				window.location = 'index.html';
			});

			getGroup.addEventListener("click", function() {
				getData(q);	
				go = true;
			});

			submit.addEventListener('click', function() {
				addData(past.value);
			})

			async function addData(datameow) {
				var d = new Date();
				var options = {
					method: 'POST',
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						id: q,
						log: datameow,
						author: q,
						name: groupName.value,
						password: groupPassword.value,
						date: d.getMonth()+1 + '/' + d.getDate() + '/' + d.getFullYear()
					})
				};
				var response = await fetch('/addGroupData', options);
				var data = await response.json();
				if (data.success === false) {
					alert(data.reason);
					return;
				}
				getData(q);
			}
			async function getData(id, human) {
				var options = {
					method: 'POST',
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						name: groupName.value,
						password: groupPassword.value
					})
				};
				var response = await fetch('/getGroupData', options);
				var data = await response.json();
				if (data.success === false) {
					if (human === false) {
						console.log(data.reason);
					} else {
						alert(data.reason);
					}
					return;
				}
				document.getElementById('logs').innerHTML = '';
				for (var i = 0; i < data.logs.length; i++) {	
					document.getElementById('logs').innerHTML += '<div id="thick">';
					newH("At " + data.logs[i].date + " " + data.logs[i].author + " posted: ", data.logs[i].log, 'logs', !(data.logs[i].author === q));

				}
				if (human === false) {
					
				} else {
					window.scrollTo(0,document.body.scrollHeight);
				}
			}

			window.setInterval(function() {
				if (go === true) {
					getData(q, false);
				}
			}, 500);
			
		</script>
	</body>
</html>